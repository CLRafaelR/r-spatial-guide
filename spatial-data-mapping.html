<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>地理空間データのマッピング | Rを使った地理空間データの可視化と分析</title>
    <meta name="description" content="オープンソースソフトウェアのR環境を使い、地理空間データに関する操作や可視化、分析手法について解説します。">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.5.1/katex.min.css">[object Object]
    
    <link rel="preload" href="assets/css/styles.add1969c.css" as="style"><link rel="preload" href="assets/js/app.add1969c.js" as="script"><link rel="preload" href="assets/js/9.247023c1.js" as="script"><link rel="prefetch" href="assets/css/1.styles.b05fc641.css"><link rel="prefetch" href="assets/css/2.styles.a2bd3099.css"><link rel="prefetch" href="assets/js/1.b05fc641.js"><link rel="prefetch" href="assets/js/10.7ff74043.js"><link rel="prefetch" href="assets/js/2.a2bd3099.js"><link rel="prefetch" href="assets/js/3.66a94749.js"><link rel="prefetch" href="assets/js/4.355f8ea2.js"><link rel="prefetch" href="assets/js/5.2c2cfdd7.js"><link rel="prefetch" href="assets/js/6.974c725e.js"><link rel="prefetch" href="assets/js/7.1eace743.js"><link rel="prefetch" href="assets/js/8.17d6b84a.js">
    <link rel="stylesheet" href="assets/css/1.styles.b05fc641.css"><link rel="stylesheet" href="assets/css/2.styles.a2bd3099.css"><link rel="stylesheet" href="assets/css/styles.add1969c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="" class="home-link router-link-active"><!----> <span class="site-name">Rを使った地理空間データの可視化と分析</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="" class="nav-link">Home</a></div><div class="nav-item"><a href="introduction.html" class="nav-link">1. 地理空間データ操作</a></div><div class="nav-item"><a href="statistical-learning.html" class="nav-link">2. 空間データ分析</a></div> <a href="https://github.com/tsukubar/r-spatial-guide" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="" class="nav-link">Home</a></div><div class="nav-item"><a href="introduction.html" class="nav-link">1. 地理空間データ操作</a></div><div class="nav-item"><a href="statistical-learning.html" class="nav-link">2. 空間データ分析</a></div> <a href="https://github.com/tsukubar/r-spatial-guide" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="" class="sidebar-link">Home</a></li><li><a href="introduction.html" class="sidebar-link">地理空間データの基本</a></li><li><a href="simple-feature-for-r.html" class="sidebar-link">Simple feature</a></li><li><a href="spatial-data-handling.html" class="sidebar-link">空間処理</a></li><li><a href="spatial-data-mapping.html" class="active sidebar-link">地理空間データのマッピング</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="spatial-data-mapping.html#利用するデータ、パッケージ" class="sidebar-link">利用するデータ、パッケージ</a></li><li class="sidebar-sub-header"><a href="spatial-data-mapping.html#base" class="sidebar-link">base</a></li><li class="sidebar-sub-header"><a href="spatial-data-mapping.html#ggplot2" class="sidebar-link">ggplot2</a></li><li class="sidebar-sub-header"><a href="spatial-data-mapping.html#tmapによる主題図作成" class="sidebar-link">tmapによる主題図作成</a></li><li class="sidebar-sub-header"><a href="spatial-data-mapping.html#geofacetによる空間位置関係を考慮したグラフ" class="sidebar-link">geofacetによる空間位置関係を考慮したグラフ</a></li><li class="sidebar-sub-header"><a href="spatial-data-mapping.html#インタクティブに動かせるマップ" class="sidebar-link">インタクティブに動かせるマップ</a></li><li class="sidebar-sub-header"><a href="spatial-data-mapping.html#deckgl" class="sidebar-link">deckgl</a></li><li class="sidebar-sub-header"><a href="spatial-data-mapping.html#plotly" class="sidebar-link">plotly</a></li><li class="sidebar-sub-header"><a href="spatial-data-mapping.html#アニメーショングラフ" class="sidebar-link">アニメーショングラフ</a></li></ul></li><li><a href="raster.html" class="sidebar-link">ラスタデータ</a></li><li><a href="statistical-learning.html" class="sidebar-link">Spatial Analysis</a></li></ul> </div> <div class="page"> <div class="content"><p>「地図」といえば紙媒体に印刷することを前提とした出力が一般的です。「地図」は現場で地物情報の状態や関係性を確認するために利用することが一般的です。しかし地図の情報量を増やすことは紙面を増やすことと同義であり、必要とする情報に応じて異なる地図を用意しなければなりません。</p> <p>従来の紙地図に対して、コンピュータで見る地図（ここでは電子地図と呼びます。）は多くの点で異なります。地図を利用する人が興味・関心のある地物の情報を選別したり、縮尺を自在に変更したりといった操作が可能です。</p> <p>ここではまず、Rの標準作図機能による地図の作成を行います。次にggplot2パッケージを使った例を紹介します。これらはいずれも印刷や画面上での表示に向いた静的な地図の作成方法です。次にウェブベースでのインタラクティブな操作が可能な空間データのマッピングについて学びます。</p> <p>地図表現には表示媒体の違いだけでなく、興味のあるデータを表現するために多様な種類が提案されてきています。全てを扱うことはできませんが、いくつかの例を紹介します。</p> <p>データ操作や処理を行うので、前章を先に読んでいてください。</p> <h2 id="利用するデータ、パッケージ"><a href="#利用するデータ、パッケージ" aria-hidden="true" class="header-anchor">#</a> 利用するデータ、パッケージ</h2> <p>この章では</p> <ul><li>国土数値情報の行政区域データ</li> <li>e-Statで公開される都道府県・市区町村別統計表 (2005(H17)、2010(H22)、2015(H27))より人口数のデータ</li></ul> <div class="language-r line-numbers-mode"><pre class="language-r"><code>library<span class="token punctuation">(</span>sf<span class="token punctuation">)</span>
library<span class="token punctuation">(</span>dplyr<span class="token punctuation">)</span>
library<span class="token punctuation">(</span>ggplot2<span class="token punctuation">)</span>
library<span class="token punctuation">(</span>patchwork<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>岡山県の行政区域データを用意します。</p> <p>また統計データとして、平成17年、22年、27年に行われた国勢調査による人口データを使います。このデータはe-statよりダウンロード可能です。</p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>library<span class="token punctuation">(</span>jpndistrict<span class="token punctuation">)</span>

sf_pref33 <span class="token operator">&lt;-</span> 
  jpn_pref<span class="token punctuation">(</span><span class="token number">33</span><span class="token punctuation">,</span> district <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span>

df_h17to27_pops <span class="token operator">&lt;-</span> 
  readr<span class="token operator">::</span>read_rds<span class="token punctuation">(</span>here<span class="token operator">::</span>here<span class="token punctuation">(</span><span class="token string">&quot;data-raw&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;population_h17-h22.rds&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-r line-numbers-mode"><pre class="language-r"><code>glimpse<span class="token punctuation">(</span>sf_pref33<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>## Observations: 30
## Variables: 5
## $ pref_code  &lt;chr&gt; &quot;33&quot;, &quot;33&quot;, &quot;33&quot;, &quot;33&quot;, &quot;33&quot;, &quot;33&quot;, &quot;33&quot;, &quot;33&quot;, &quot;33...
## $ prefecture &lt;chr&gt; &quot;岡山県&quot;, &quot;岡山県&quot;, &quot;岡山県&quot;, &quot;岡山県&quot;, &quot;岡山県&quot;, &quot;岡山県&quot;, &quot;岡山県&quot;, &quot;岡...
## $ city_code  &lt;chr&gt; &quot;33101&quot;, &quot;33102&quot;, &quot;33103&quot;, &quot;33104&quot;, &quot;33202&quot;, &quot;33203...
## $ city       &lt;chr&gt; &quot;岡山市 北区&quot;, &quot;岡山市 中区&quot;, &quot;岡山市 東区&quot;, &quot;岡山市 南区&quot;, &quot;倉敷市&quot;, &quot;津山市...
## $ geometry   &lt;GEOMETRY [°]&gt; POLYGON ((133.9098 34.948, ..., MULTIPOLYG...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language-r line-numbers-mode"><pre class="language-r"><code>glimpse<span class="token punctuation">(</span>df_h17to27_pops<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>## Observations: 6,363
## Variables: 6
## $ year       &lt;dbl&gt; 2005, 2005, 2005, 2005, 2005, 2005, 2005, 2005, 200...
## $ pref_code  &lt;chr&gt; &quot;00&quot;, &quot;01&quot;, &quot;01&quot;, &quot;01&quot;, &quot;01&quot;, &quot;01&quot;, &quot;01&quot;, &quot;01&quot;, &quot;01...
## $ city_code  &lt;chr&gt; &quot;00000&quot;, &quot;01000&quot;, &quot;01100&quot;, &quot;01101&quot;, &quot;01102&quot;, &quot;01103...
## $ city_type  &lt;chr&gt; &quot;a&quot;, &quot;a&quot;, &quot;1&quot;, &quot;0&quot;, &quot;0&quot;, &quot;0&quot;, &quot;0&quot;, &quot;0&quot;, &quot;0&quot;, &quot;0&quot;, &quot;...
## $ city       &lt;chr&gt; &quot;全国&quot;, &quot;北海道&quot;, &quot;札幌市&quot;, &quot;札幌市 中央区&quot;, &quot;札幌市 北区&quot;, &quot;札幌市 東区&quot;, ...
## $ population &lt;dbl&gt; 127767994, 5627737, 1880863, 202801, 272877, 253996...
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h2 id="base"><a href="#base" aria-hidden="true" class="header-anchor">#</a> base</h2> <div class="language-r line-numbers-mode"><pre class="language-r"><code>plot<span class="token punctuation">(</span>sf_pref33<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="images/unnamed-chunk-6-1.png" alt="plot of chunk unnamed-chunk-6"></p> <p>sfオブジェクトに対して<code>plot()</code>を適用した場合、デフォルトでは全ての属性について作図を行います。</p> <p>そのため、地物の形状あるいは特定の属性について確認したい際には次のようにします。<code>[</code>演算子で対象の属性を含む列を指定するか、<code>st_geometry()</code>を使います。</p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>sf_pref33 <span class="token percent-operator operator">%&gt;%</span> 
  st_geometry<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
  plot<span class="token punctuation">(</span>col <span class="token operator">=</span> <span class="token string">&quot;white&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="images/unnamed-chunk-7-1.png" alt="plot of chunk unnamed-chunk-7"></p> <p><code>options(sf_max.plot =)</code>で描画される数を制御することも可能です。これによりセッションが終了するまで設定を維持できます。ただし、この設定が予期せぬ結果を招くこともあるので、描画対象は都度指定するようにした方が良いでしょう。</p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>options<span class="token punctuation">(</span>sf_max.plot <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span>
sf_pref33 <span class="token percent-operator operator">%&gt;%</span> 
  plot<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="images/unnamed-chunk-8-1.png" alt="plot of chunk unnamed-chunk-8"></p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>sf_pref33<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token string">&quot;city&quot;</span><span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span> 
  plot<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p><img src="images/unnamed-chunk-9-1.png" alt="plot of chunk unnamed-chunk-9"></p> <p>ここで日本語が文字化けする時には<code>par()</code>による作図パラメータの調整を行う必要があります。</p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>par<span class="token punctuation">(</span>family <span class="token operator">=</span> <span class="token string">&quot;IPAexGothic&quot;</span><span class="token punctuation">,</span>
    oma <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">6.5</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
    mar <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
sf_pref33<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token string">&quot;city&quot;</span><span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span> 
  plot<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p><img src="images/unnamed-chunk-10-1.png" alt="plot of chunk unnamed-chunk-10"></p> <p>凡例は標準で図の右側に配置されますが、これは<code>key.pos</code>引数で位置を調整できます。</p> <div class="language-r line-numbers-mode"><pre class="language-r"><code><span class="token comment"># 1は下部、2は右側、3は上部、4は右側</span>
sf_pref33<span class="token punctuation">[</span><span class="token punctuation">,</span> <span class="token string">&quot;city&quot;</span><span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span> 
  plot<span class="token punctuation">(</span>key.pos <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="images/unnamed-chunk-11-1.png" alt="plot of chunk unnamed-chunk-11"></p> <h2 id="ggplot2"><a href="#ggplot2" aria-hidden="true" class="header-anchor">#</a> ggplot2</h2> <p>ggplot2にはsfパッケージが扱う地理空間オブジェクトを描画する専用の関数が用意されています。<code>geom_sf()</code>は引数<code>data</code>にsf、sfc、sfgを与えることで、地物の描画を行います。</p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>x <span class="token operator">&lt;-</span> st_point<span class="token punctuation">(</span>c<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

ggplot<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  geom_sf<span class="token punctuation">(</span>data <span class="token operator">=</span> x<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="images/unnamed-chunk-12-1.png" alt="plot of chunk unnamed-chunk-12"></p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>ggplot<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  geom_sf<span class="token punctuation">(</span>data <span class="token operator">=</span> sf_pref33<span class="token punctuation">,</span> aes<span class="token punctuation">(</span>fill <span class="token operator">=</span> city_code<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  <span class="token comment"># 経緯度線を描画しない</span>
  coord_sf<span class="token punctuation">(</span>datum <span class="token operator">=</span> <span class="token keyword">NA</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  guides<span class="token punctuation">(</span>fill <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  <span class="token comment"># 背景色を白にする</span>
  theme_void<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><img src="images/unnamed-chunk-13-1.png" alt="plot of chunk unnamed-chunk-13"></p> <p><code>geom_sf()</code>では凡例の出力を調整するための引数<code>show.legend</code>が用意されています。この凡例では、既定値に<code>NA</code>が与えられていますが、<code>aes()</code>でマッピングを指定した場合、凡例が与えられます。またこの時の凡例は&quot;polygon&quot;ですが、&quot;line&quot;または&quot;point&quot;と明示的に指定することが可能です。</p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>sf_kitaku <span class="token operator">&lt;-</span> 
  sf_pref33<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;geometry&quot;</span><span class="token punctuation">]</span> <span class="token percent-operator operator">%&gt;%</span> 
  st_cast<span class="token punctuation">(</span><span class="token string">&quot;MULTILINESTRING&quot;</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
  st_cast<span class="token punctuation">(</span><span class="token string">&quot;LINESTRING&quot;</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
    mutate<span class="token punctuation">(</span>id <span class="token operator">=</span> letters<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

<span class="token comment"># 凡例を描画しない</span>
p1 <span class="token operator">&lt;-</span> 
  ggplot<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  geom_sf<span class="token punctuation">(</span>data <span class="token operator">=</span> sf_kitaku<span class="token punctuation">,</span> 
  aes<span class="token punctuation">(</span>col <span class="token operator">=</span> id<span class="token punctuation">)</span><span class="token punctuation">,</span>
  show.legend <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>
<span class="token comment"># 凡例を描画する (polygonとして扱われる)</span>
p2 <span class="token operator">&lt;-</span> 
  ggplot<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  geom_sf<span class="token punctuation">(</span>data <span class="token operator">=</span> sf_kitaku<span class="token punctuation">,</span> 
  aes<span class="token punctuation">(</span>col <span class="token operator">=</span> id<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token comment"># 凡例を描画する (種類を指定する)</span>
p3 <span class="token operator">&lt;-</span> 
  ggplot<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  geom_sf<span class="token punctuation">(</span>data <span class="token operator">=</span> sf_kitaku<span class="token punctuation">,</span> 
  aes<span class="token punctuation">(</span>col <span class="token operator">=</span> id<span class="token punctuation">)</span><span class="token punctuation">,</span>
  show.legend <span class="token operator">=</span> <span class="token string">&quot;line&quot;</span><span class="token punctuation">)</span>

p1 <span class="token operator">+</span> p2 <span class="token operator">+</span> p3 <span class="token operator">+</span> 
  plot_layout<span class="token punctuation">(</span>ncol <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><p><img src="images/unnamed-chunk-14-1.png" alt="plot of chunk unnamed-chunk-14"></p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>set.seed<span class="token punctuation">(</span><span class="token number">123</span><span class="token punctuation">)</span>

ggplot<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  geom_sf<span class="token punctuation">(</span>data <span class="token operator">=</span> sf_pref33<span class="token punctuation">,</span> fill <span class="token operator">=</span> <span class="token string">&quot;white&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  geom_sf<span class="token punctuation">(</span>data <span class="token operator">=</span> 
            sf_pref33 <span class="token percent-operator operator">%&gt;%</span> 
            st_sample<span class="token punctuation">(</span>size <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
            st_sf<span class="token punctuation">(</span>id <span class="token operator">=</span> letters<span class="token punctuation">[</span>seq<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">7</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          aes<span class="token punctuation">(</span>color <span class="token operator">=</span> id<span class="token punctuation">)</span><span class="token punctuation">,</span>
          show.legend <span class="token operator">=</span> <span class="token string">&quot;point&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  guides<span class="token punctuation">(</span>fill <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>## although coordinates are longitude/latitude, st_intersects assumes that they are planar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="images/unnamed-chunk-15-1.png" alt="plot of chunk unnamed-chunk-15"></p> <blockquote><p>Error in grid.Call(C_textBounds, as.graphicsAnnot(x<span class="katex"><span class="katex-mathml"><math><semantics><mrow><mi>l</mi><mi>a</mi><mi>b</mi><mi>e</mi><mi>l</mi><mo>)</mo><mo separator="true">,</mo><mi>x</mi></mrow><annotation encoding="application/x-tex">label), x</annotation></semantics></math></span><span aria-hidden="true" class="katex-html"><span class="strut" style="height:0.75em;"></span><span class="strut bottom" style="height:1em;vertical-align:-0.25em;"></span><span class="base textstyle uncramped"><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mord mathit">a</span><span class="mord mathit">b</span><span class="mord mathit">e</span><span class="mord mathit" style="margin-right:0.01968em;">l</span><span class="mclose">)</span><span class="mpunct">,</span><span class="mord mathit">x</span></span></span></span>x, x$y,  :
polygon edge not found</p></blockquote> <p>というエラーがでることがあります。</p> <p>何度か描画しているとエラーが発生せずに描画が行われます。</p> <h3 id="facet"><a href="#facet" aria-hidden="true" class="header-anchor">#</a> facet</h3> <div class="language-r line-numbers-mode"><pre class="language-r"><code>df_pops_pref33 <span class="token operator">&lt;-</span> 
  df_h17to27_pops <span class="token percent-operator operator">%&gt;%</span> 
  filter<span class="token punctuation">(</span>city <span class="token operator">!=</span> <span class="token string">&quot;全国&quot;</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
  filter<span class="token punctuation">(</span>pref_code <span class="token operator">==</span> <span class="token string">&quot;33&quot;</span><span class="token punctuation">,</span> city_type <span class="token percent-operator operator">%in%</span> c<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>空間データと統計データの紐付けは下記のように行います。まず、共通する「キー」と呼ばれる列を作ります。</p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>sf_pref33 <span class="token operator">&lt;-</span> 
  sf_pref33 <span class="token percent-operator operator">%&gt;%</span> 
  mutate<span class="token punctuation">(</span>city_code <span class="token operator">=</span> if_else<span class="token punctuation">(</span>stringr<span class="token operator">::</span>str_detect<span class="token punctuation">(</span>city<span class="token punctuation">,</span> <span class="token string">&quot;[[:space:]].+区$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
                             stringr<span class="token operator">::</span>str_replace<span class="token punctuation">(</span>city_code<span class="token punctuation">,</span> <span class="token string">&quot;.{1}$&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                             city_code<span class="token punctuation">)</span><span class="token punctuation">,</span>
         city <span class="token operator">=</span> stringr<span class="token operator">::</span>str_remove<span class="token punctuation">(</span>city<span class="token punctuation">,</span> <span class="token string">&quot;[[:space:]].+区$&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
         city <span class="token operator">=</span> stringr<span class="token operator">::</span>str_remove<span class="token punctuation">(</span>city<span class="token punctuation">,</span> <span class="token string">&quot;^.+郡[[:space:]]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
  group_by<span class="token punctuation">(</span>city_code<span class="token punctuation">,</span> city<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
  tidyr<span class="token operator">::</span>nest<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><div class="language-r line-numbers-mode"><pre class="language-r"><code>city_union <span class="token operator">&lt;-</span> <span class="token keyword">function</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  x <span class="token percent-operator operator">%&gt;%</span> 
    lwgeom<span class="token operator">::</span>st_make_valid<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
    sf<span class="token operator">::</span>st_union<span class="token punctuation">(</span>by_feature <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
    sf<span class="token operator">::</span>st_transform<span class="token punctuation">(</span>crs <span class="token operator">=</span> <span class="token number">4326</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
    sf<span class="token operator">::</span>st_cast<span class="token punctuation">(</span><span class="token string">&quot;POLYGON&quot;</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
    purrr<span class="token operator">::</span>map<span class="token punctuation">(</span>
      <span class="token operator">~</span> .x<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
    <span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
    sf<span class="token operator">::</span>st_multipolygon<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
    sf<span class="token operator">::</span>st_sfc<span class="token punctuation">(</span>crs <span class="token operator">=</span> <span class="token number">4326</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

sf_pref33 <span class="token operator">&lt;-</span> 
  sf_pref33 <span class="token percent-operator operator">%&gt;%</span> 
  transmute<span class="token punctuation">(</span>city_code<span class="token punctuation">,</span>
            city<span class="token punctuation">,</span>
            geometry <span class="token operator">=</span> purrr<span class="token operator">::</span>map<span class="token punctuation">(</span>data<span class="token punctuation">,</span> <span class="token operator">~</span> city_union<span class="token punctuation">(</span>.x<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
              purrr<span class="token operator">::</span>reduce<span class="token punctuation">(</span>c<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
  st_sf<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><div class="language-r line-numbers-mode"><pre class="language-r"><code><span class="token comment"># 合併により統合された町</span>
df_pops_pref33 <span class="token percent-operator operator">%&gt;%</span> 
  anti_join<span class="token punctuation">(</span>sf_pref33<span class="token punctuation">,</span> by <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token string">&quot;city_code&quot;</span><span class="token punctuation">,</span> 
                              <span class="token string">&quot;city&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>## # A tibble: 7 x 6
##    year pref_code city_code city_type city   population
##   &lt;dbl&gt; &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;     &lt;chr&gt;       &lt;dbl&gt;
## 1  2005 33        33201     2         岡山市     674746
## 2  2005 33        33303     3         建部町       6524
## 3  2005 33        33321     3         瀬戸町      14902
## 4  2005 33        33345     3         佐伯町       3931
## 5  2005 33        33442     3         金光町      12341
## 6  2005 33        33443     3         鴨方町      18475
## 7  2005 33        33444     3         寄島町       6511
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><div class="language-r line-numbers-mode"><pre class="language-r"><code><span class="token comment"># 市町村合併による結果を適用。人口数を再計算</span>
df_pops_pref33 <span class="token operator">&lt;-</span> 
  df_pops_pref33 <span class="token percent-operator operator">%&gt;%</span> 
  mutate<span class="token punctuation">(</span>city_code <span class="token operator">=</span> recode<span class="token punctuation">(</span>
    city_code<span class="token punctuation">,</span>
    `<span class="token number">33201</span>` <span class="token operator">=</span> <span class="token string">&quot;33100&quot;</span><span class="token punctuation">,</span>
    `<span class="token number">33303</span>` <span class="token operator">=</span> <span class="token string">&quot;33100&quot;</span><span class="token punctuation">,</span>
    `<span class="token number">33321</span>` <span class="token operator">=</span> <span class="token string">&quot;33100&quot;</span><span class="token punctuation">,</span>
    `<span class="token number">33345</span>` <span class="token operator">=</span> <span class="token string">&quot;33346&quot;</span><span class="token punctuation">,</span>
    `<span class="token number">33442</span>` <span class="token operator">=</span> <span class="token string">&quot;33216&quot;</span><span class="token punctuation">,</span>
    `<span class="token number">33443</span>` <span class="token operator">=</span> <span class="token string">&quot;33216&quot;</span><span class="token punctuation">,</span>
    `<span class="token number">33444</span>` <span class="token operator">=</span> <span class="token string">&quot;33216&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
  group_by<span class="token punctuation">(</span>year<span class="token punctuation">,</span> city_code<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
  mutate<span class="token punctuation">(</span>population <span class="token operator">=</span> sum<span class="token punctuation">(</span>population<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
  ungroup<span class="token punctuation">(</span><span class="token punctuation">)</span>

df_pops_pref33 <span class="token operator">&lt;-</span> 
  sf_pref33 <span class="token percent-operator operator">%&gt;%</span> 
  inner_join<span class="token punctuation">(</span>df_pops_pref33<span class="token punctuation">,</span> by <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token string">&quot;city_code&quot;</span><span class="token punctuation">,</span> 
                       <span class="token string">&quot;city&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div><div class="language-r line-numbers-mode"><pre class="language-r"><code>ggplot<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  geom_sf<span class="token punctuation">(</span>data <span class="token operator">=</span> df_pops_pref33<span class="token punctuation">,</span> aes<span class="token punctuation">(</span>fill <span class="token operator">=</span> population<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  scale_fill_viridis_c<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  facet_wrap<span class="token punctuation">(</span><span class="token operator">~</span> year<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="images/unnamed-chunk-21-1.png" alt="plot of chunk unnamed-chunk-21"></p> <p>階級分け</p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>df_pops_pref33_cls <span class="token operator">&lt;-</span> 
  df_pops_pref33 <span class="token percent-operator operator">%&gt;%</span> 
  group_by<span class="token punctuation">(</span>year<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
  mutate<span class="token punctuation">(</span>cls <span class="token operator">=</span> dplyr<span class="token operator">::</span>ntile<span class="token punctuation">(</span>population<span class="token punctuation">,</span> <span class="token number">9</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
  ungroup<span class="token punctuation">(</span><span class="token punctuation">)</span>

ggplot<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  geom_sf<span class="token punctuation">(</span>data <span class="token operator">=</span> df_pops_pref33_cls<span class="token punctuation">,</span> 
          aes<span class="token punctuation">(</span>fill <span class="token operator">=</span> population<span class="token punctuation">)</span><span class="token punctuation">,</span> 
          color <span class="token operator">=</span> <span class="token string">&quot;white&quot;</span><span class="token punctuation">,</span> size <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  scale_fill_viridis_c<span class="token punctuation">(</span>guide <span class="token operator">=</span> guide_legend<span class="token punctuation">(</span>title <span class="token operator">=</span> <span class="token string">&quot;Population&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  facet_wrap<span class="token punctuation">(</span><span class="token operator">~</span> year<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><img src="images/unnamed-chunk-22-1.png" alt="plot of chunk unnamed-chunk-22"></p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>ggplot<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  geom_sf<span class="token punctuation">(</span>data <span class="token operator">=</span> df_pops_pref33_cls<span class="token punctuation">,</span> aes<span class="token punctuation">(</span>fill <span class="token operator">=</span> as.character<span class="token punctuation">(</span>cls<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
          color <span class="token operator">=</span> <span class="token string">&quot;white&quot;</span><span class="token punctuation">,</span> size <span class="token operator">=</span> <span class="token number">0.1</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  scale_fill_viridis_d<span class="token punctuation">(</span>guide <span class="token operator">=</span> guide_legend<span class="token punctuation">(</span>title <span class="token operator">=</span> <span class="token string">&quot;Class&quot;</span><span class="token punctuation">,</span> 
                                            reverse <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  theme_light<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  facet_wrap<span class="token punctuation">(</span><span class="token operator">~</span> year<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p><img src="images/unnamed-chunk-23-1.png" alt="plot of chunk unnamed-chunk-23"></p> <h2 id="tmapによる主題図作成"><a href="#tmapによる主題図作成" aria-hidden="true" class="header-anchor">#</a> tmapによる主題図作成</h2> <div class="language-r line-numbers-mode"><pre class="language-r"><code>library<span class="token punctuation">(</span>tmap<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-r line-numbers-mode"><pre class="language-r"><code>qtm<span class="token punctuation">(</span>sf_pref33<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="images/unnamed-chunk-25-1.png" alt="plot of chunk unnamed-chunk-25"></p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>tm_shape<span class="token punctuation">(</span>sf_pref33<span class="token punctuation">,</span> 
         projection <span class="token operator">=</span> <span class="token string">&quot;longlat&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> 
    tm_polygons<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="images/unnamed-chunk-26-1.png" alt="plot of chunk unnamed-chunk-26"></p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>tmap_mode<span class="token punctuation">(</span><span class="token string">&quot;view&quot;</span><span class="token punctuation">)</span>

tm_shape<span class="token punctuation">(</span>sf_pref33<span class="token punctuation">)</span> <span class="token operator">+</span> 
  tm_fill<span class="token punctuation">(</span><span class="token string">&quot;city_code&quot;</span><span class="token punctuation">,</span> palette <span class="token operator">=</span> sf.colors<span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-r line-numbers-mode"><pre class="language-r"><code>qtm<span class="token punctuation">(</span>sf_pref33<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="images/unnamed-chunk-28-1.png" alt="plot of chunk unnamed-chunk-28"></p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>tm_shape<span class="token punctuation">(</span>sf_pref33<span class="token punctuation">)</span> <span class="token operator">+</span>
  tm_polygons<span class="token punctuation">(</span><span class="token string">&quot;city&quot;</span><span class="token punctuation">,</span>
              title <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
              size <span class="token operator">=</span> <span class="token number">0.2</span><span class="token punctuation">,</span> 
              bg.color <span class="token operator">=</span> <span class="token string">&quot;white&quot;</span><span class="token punctuation">,</span> 
              border.col <span class="token operator">=</span> <span class="token string">&quot;gray50&quot;</span><span class="token punctuation">,</span> 
              border.alpha <span class="token operator">=</span> <span class="token number">.5</span><span class="token punctuation">,</span>
              bg.alpha <span class="token operator">=</span> <span class="token number">0.25</span><span class="token punctuation">,</span>
              outer.margins <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.2</span><span class="token punctuation">,</span> <span class="token number">0.1</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  tm_legend<span class="token punctuation">(</span>position <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token string">&quot;right&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;bottom&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
            inner.margins <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token number">0.01</span><span class="token punctuation">,</span> <span class="token number">0.05</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  tm_layout<span class="token punctuation">(</span>frame <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">,</span> 
            title <span class="token operator">=</span> <span class="token string">&quot;岡山県&quot;</span><span class="token punctuation">,</span>
            fontfamily <span class="token operator">=</span> <span class="token string">&quot;IPAexGothic&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p><img src="images/unnamed-chunk-28-2.png" alt="plot of chunk unnamed-chunk-28"></p> <h2 id="geofacetによる空間位置関係を考慮したグラフ"><a href="#geofacetによる空間位置関係を考慮したグラフ" aria-hidden="true" class="header-anchor">#</a> geofacetによる空間位置関係を考慮したグラフ</h2> <div class="language-r line-numbers-mode"><pre class="language-r"><code>library<span class="token punctuation">(</span>geofacet<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>人口数のデータ</p> <p>city_typeを元に47都道府県のデータに限定します。</p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>df_h17to27_pops_target <span class="token operator">&lt;-</span>
  df_h17to27_pops <span class="token percent-operator operator">%&gt;%</span> 
  filter<span class="token punctuation">(</span>city <span class="token operator">!=</span> <span class="token string">&quot;全国&quot;</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
  filter<span class="token punctuation">(</span>city_type <span class="token operator">==</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language-r line-numbers-mode"><pre class="language-r"><code><span class="token comment"># 各県のデータが3回の調査回数分あることを確認</span>
df_h17to27_pops_target <span class="token percent-operator operator">%&gt;%</span> 
  count<span class="token punctuation">(</span>pref_code<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
  filter<span class="token punctuation">(</span><span class="token operator">!</span>between<span class="token punctuation">(</span>n<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>## # A tibble: 0 x 2
## # ... with 2 variables: pref_code &lt;chr&gt;, n &lt;int&gt;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>元のデータにありますが、前回の調査時からの増減を示す列 (<code>increase</code>... <code>TRUE</code>である場合に増加を示す) を作成します。</p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>df_h17to27_pops_target <span class="token operator">&lt;-</span>
  df_h17to27_pops_target <span class="token percent-operator operator">%&gt;%</span> 
  arrange<span class="token punctuation">(</span>pref_code<span class="token punctuation">,</span> year<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
  group_by<span class="token punctuation">(</span>pref_code<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
  mutate<span class="token punctuation">(</span>increace <span class="token operator">=</span> if_else<span class="token punctuation">(</span>population <span class="token operator">&gt;</span> lag<span class="token punctuation">(</span>population<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
  ungroup<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
  arrange<span class="token punctuation">(</span>year<span class="token punctuation">,</span> pref_code<span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
  mutate<span class="token punctuation">(</span>name <span class="token operator">=</span> rep<span class="token punctuation">(</span>jp_prefs_grid1<span class="token operator">$</span>name<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><div class="language-r line-numbers-mode"><pre class="language-r"><code>p_base <span class="token operator">&lt;-</span> 
  df_h17to27_pops_target <span class="token percent-operator operator">%&gt;%</span> 
  ggplot<span class="token punctuation">(</span>aes<span class="token punctuation">(</span>year<span class="token punctuation">,</span> population<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  geom_point<span class="token punctuation">(</span>aes<span class="token punctuation">(</span>color <span class="token operator">=</span> increace<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  scale_color_manual<span class="token punctuation">(</span>values <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token string">&quot;TRUE&quot;</span>  <span class="token operator">=</span> viridisLite<span class="token operator">::</span>viridis<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> 
                                <span class="token string">&quot;FALSE&quot;</span> <span class="token operator">=</span> viridisLite<span class="token operator">::</span>viridis<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                     na.value <span class="token operator">=</span> <span class="token string">&quot;gray&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  geom_line<span class="token punctuation">(</span>color <span class="token operator">=</span> <span class="token string">&quot;gray&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  guides<span class="token punctuation">(</span>color <span class="token operator">=</span> guide_legend<span class="token punctuation">(</span>title <span class="token operator">=</span> <span class="token string">&quot;人口の増加&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  scale_x_continuous<span class="token punctuation">(</span>breaks <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">2005</span><span class="token punctuation">,</span> <span class="token number">2010</span><span class="token punctuation">,</span> <span class="token number">2015</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  scale_y_continuous<span class="token punctuation">(</span>labels <span class="token operator">=</span> scales<span class="token operator">::</span>comma<span class="token punctuation">,</span> 
                     breaks <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token number">500000</span><span class="token punctuation">,</span> <span class="token number">1500000</span><span class="token punctuation">,</span> <span class="token number">3000000</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  theme_light<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span>
  theme<span class="token punctuation">(</span>legend.position <span class="token operator">=</span> <span class="token string">&quot;top&quot;</span><span class="token punctuation">,</span>
        legend.direction <span class="token operator">=</span> <span class="token string">&quot;horizontal&quot;</span><span class="token punctuation">,</span>
        axis.text    <span class="token operator">=</span> element_text<span class="token punctuation">(</span>size <span class="token operator">=</span> <span class="token number">5.2</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        strip.text.x <span class="token operator">=</span> element_text<span class="token punctuation">(</span>size <span class="token operator">=</span> <span class="token number">7.6</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>空間配置を考慮しない図</p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>p_base <span class="token operator">+</span>
  facet_wrap<span class="token punctuation">(</span><span class="token operator">~</span> pref_code<span class="token punctuation">,</span>
             scales <span class="token operator">=</span> <span class="token string">&quot;free_y&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><img src="images/unnamed-chunk-34-1.png" alt="plot of chunk unnamed-chunk-34"></p> <p>geofacetを利用した図</p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>p_base <span class="token operator">+</span> 
  facet_geo<span class="token punctuation">(</span><span class="token operator">~</span> name<span class="token punctuation">,</span> 
            grid <span class="token operator">=</span> <span class="token string">&quot;jp_prefs_grid1&quot;</span><span class="token punctuation">,</span>
            scales <span class="token operator">=</span> <span class="token string">&quot;free_y&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p><img src="images/unnamed-chunk-35-1.png" alt="plot of chunk unnamed-chunk-35"></p> <h2 id="インタクティブに動かせるマップ"><a href="#インタクティブに動かせるマップ" aria-hidden="true" class="header-anchor">#</a> インタクティブに動かせるマップ</h2> <h3 id="mapedit-mapview"><a href="#mapedit-mapview" aria-hidden="true" class="header-anchor">#</a> mapedit / mapview</h3> <p>QGISやArcGISのような高機能なGIS機能はありませんが、</p> <p>地理空間データを閲覧したり、簡単なデータの作成・加工を行うのに十分な機能を備えています。</p> <p>インタラクティブに扱うためのパッケージです。</p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>library<span class="token punctuation">(</span>mapview<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><code>mapview()</code>を実行すると、leafletベースの画面が表示されます。これは興味のある対象へズームしたり表示する場所を変更したりといった操作が可能です。</p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>mapview<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p><img src="images/unnamed-chunk-37-1.png" alt="plot of chunk unnamed-chunk-37"></p> <p>しかし表示されているのはベースタイルの情報のみです。ここに用意した地理空間データをマッピングするには<code>mapview()</code>の引数にオブジェクトを渡して実行します。</p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>mapview<span class="token punctuation">(</span>stations<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>全国の観測所の位置が地図上にマッピングされました。各ポイントのマーカーを選択すると、地物の属性情報を確認できます。また<code>zcol</code>引数に属性の名前を与えて、表示項目の塗り分けを行うことが可能です。次の例は、stationsデータの観測所の種類を記録したstation_typeの列を基準に地物の塗り分けを行うものです。</p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>mapview<span class="token punctuation">(</span>stations<span class="token punctuation">,</span> zcol <span class="token operator">=</span> <span class="token string">&quot;station_type&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>塗り分けを行っても、このデータはポイントの数が多すぎて詳細を把握することができません。しかしmapviewパッケージは静的な地図の描画ではなくて動的な地図を提供することを思い出してください。例えばもしあなたが北海道の観測所に興味がある場合、対象を拡大表示すれば良いのです。しかし、もし関心が北海道の観測所であることが初めから決まっているのであれば、表示するデータをあらかじめ北海道のものに限定しておくという処理が適切でしょう。</p> <p>mapviewでは一般的なGISアプリケーションのように、レイヤーとして地理空間データを重ね合わせることができます。ここでは北海道内の観測所データと、北海道の行政区域データという2つのレイヤーを用意してその例を示します。</p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>library<span class="token punctuation">(</span>dplyr<span class="token punctuation">)</span>
library<span class="token punctuation">(</span>jpndistrict<span class="token punctuation">)</span>

sf_pref01 <span class="token operator">&lt;-</span> 
  jpn_pref<span class="token punctuation">(</span><span class="token string">&quot;01&quot;</span><span class="token punctuation">,</span> district <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span>

m <span class="token operator">&lt;-</span> 
  stations <span class="token percent-operator operator">%&gt;%</span> 
  dplyr<span class="token operator">::</span>filter<span class="token punctuation">(</span>pref_code <span class="token operator">==</span> <span class="token string">&quot;01&quot;</span><span class="token punctuation">)</span> <span class="token percent-operator operator">%&gt;%</span> 
  mapview<span class="token punctuation">(</span>zcol <span class="token operator">=</span> <span class="token string">&quot;station_type&quot;</span><span class="token punctuation">)</span> <span class="token operator">+</span> 
  mapview<span class="token punctuation">(</span>sf_pref01<span class="token punctuation">)</span>

m
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p><img src="images/unnamed-chunk-40-1.png" alt="plot of chunk unnamed-chunk-40"></p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>mapedit<span class="token operator">::</span>drawFeatures<span class="token punctuation">(</span>mapview<span class="token punctuation">(</span>sf_pref01<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><ul><li>geometryを作成する</li> <li>マーカーを配置する</li> <li>編集（位置の修正）、削除</li></ul> <p>作業を終えたら &quot;Done&quot; を押してアプリケーションを停止させましょう。アプリケーション上で作成したデータは<code>.Last.value</code>に保存されています。再利用のために名前つきのオブジェクトに代入しておきましょう。（ここに保存されるデータは新しい処理を実行すると上書きされるので注意です。）</p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>my_features <span class="token operator">&lt;-</span> 
  .Last.value

my_features
<span class="token comment"># Simple feature collection with 5 features and 3 fields</span>
<span class="token comment"># geometry type:  POINT</span>
<span class="token comment"># dimension:      XY</span>
<span class="token comment"># bbox:           xmin: 141.0315 ymin: 42.88402 xmax: 143.9648 ymax: 44.22874</span>
<span class="token comment"># epsg (SRID):    4326</span>
<span class="token comment"># proj4string:    +proj=longlat +datum=WGS84 +no_defs</span>
<span class="token comment">#   X_leaflet_id feature_type radius                  geometry</span>
<span class="token comment"># 1          282       marker     NA POINT (143.9648 43.79404)</span>
<span class="token comment"># 2          288       marker     NA POINT (142.1851 42.88401)</span>
<span class="token comment"># 3          295       marker     NA POINT (142.1521 44.22874)</span>
<span class="token comment"># 4          357 circlemarker     10 POINT (142.2015 43.71508)</span>
<span class="token comment"># 5          373 circlemarker     10 POINT (141.0315 42.91553)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>レイヤーの追加は、 <code>+ mapview()</code>の形式で実行します。</p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>station_point_pref01 <span class="token operator">&lt;-</span> 
  stations <span class="token percent-operator operator">%&gt;%</span> 
  dplyr<span class="token operator">::</span>filter<span class="token punctuation">(</span>pref_code <span class="token operator">==</span> <span class="token string">&quot;01&quot;</span><span class="token punctuation">)</span>

mapview<span class="token punctuation">(</span>
  list<span class="token punctuation">(</span>station_point_pref01<span class="token punctuation">,</span> sf_pref01<span class="token punctuation">)</span><span class="token punctuation">,</span>
  zcol <span class="token operator">=</span> list<span class="token punctuation">(</span><span class="token string">&quot;station_type&quot;</span><span class="token punctuation">,</span> <span class="token keyword">NULL</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  legend <span class="token operator">=</span> list<span class="token punctuation">(</span><span class="token boolean">TRUE</span><span class="token punctuation">,</span> <span class="token boolean">FALSE</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  homebutton <span class="token operator">=</span> list<span class="token punctuation">(</span><span class="token boolean">FALSE</span><span class="token punctuation">,</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><img src="images/unnamed-chunk-43-1.png" alt="plot of chunk unnamed-chunk-43"></p> <p>レイヤーの表示切り替え、ホーム位置への移動、全体表示（ズームレベルのリセット）</p> <p>mapviewパッケージの機能について理解を深めるために、パッケージの実装面を学んでいきましょう。<code>mapview()</code>の返り値はS4クラスのオブジェクトです。object、mapという2つのスロットからなります。</p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>str<span class="token punctuation">(</span>m<span class="token punctuation">,</span> max.level <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>## Formal class 'mapview' [package &quot;mapview&quot;] with 2 slots
##   ..@ object:List of 2
##   .. ..$ :sfc_POINT of length 228; first list element:  'XY' num [1:2] 141.9 45.5
##   .. ..$ :sfc_MULTIPOLYGON of length 1; first list element: List of 239
##   .. .. ..- attr(*, &quot;class&quot;)= chr [1:3] &quot;XY&quot; &quot;MULTIPOLYGON&quot; &quot;sfg&quot;
##   ..@ map   :List of 8
##   .. ..$ x            :List of 4
##   .. ..$ width        : NULL
##   .. ..$ height       : NULL
##   .. ..$ sizingPolicy :List of 6
##   .. ..$ dependencies :List of 4
##   .. ..$ elementId    : NULL
##   .. ..$ preRenderHook:function (widget)  
##   .. ..$ jsHooks      :List of 1
##   .. ..- attr(*, &quot;class&quot;)= chr [1:2] &quot;leaflet&quot; &quot;htmlwidget&quot;
##   .. ..- attr(*, &quot;package&quot;)= chr &quot;leaflet&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>objectスロットにはマッピングに使われるデータが保存されています。</p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>m<span class="token operator">@</span>object<span class="token punctuation">[</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">]</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>## Geometry set for 228 features 
## geometry type:  POINT
## dimension:      XY
## bbox:           xmin: 139.4167 ymin: 41.41667 xmax: 145.75 ymax: 45.51667
## epsg (SRID):    4326
## proj4string:    +proj=longlat +datum=WGS84 +no_defs
## First 5 geometries:
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>## POINT (141.9333 45.51667)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>## POINT (141.6667 45.4)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>## POINT (141.045 45.3)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>## POINT (141.8 45.4)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>## POINT (142.1667 45.33333)
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="多様なオプション"><a href="#多様なオプション" aria-hidden="true" class="header-anchor">#</a> 多様なオプション</h4> <div class="language-r line-numbers-mode"><pre class="language-r"><code>mapview<span class="token punctuation">(</span>sf_pref01<span class="token punctuation">,</span>
        col.regions <span class="token operator">=</span> <span class="token string">&quot;magenta&quot;</span><span class="token punctuation">)</span>

mapview<span class="token punctuation">(</span>station_point_pref01<span class="token punctuation">,</span>
        zcol <span class="token operator">=</span> <span class="token string">&quot;station_type&quot;</span><span class="token punctuation">,</span>
        col.regions <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token string">&quot;orange&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;violet&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;blue&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;cyan&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        popup <span class="token operator">=</span> popupTable<span class="token punctuation">(</span>station_point_pref01<span class="token punctuation">,</span>
                           zcol <span class="token operator">=</span> c<span class="token punctuation">(</span><span class="token string">&quot;station_name&quot;</span><span class="token punctuation">,</span>
                                    <span class="token string">&quot;elevation&quot;</span><span class="token punctuation">,</span>
                                    <span class="token string">&quot;address&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        legend <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">,</span>
        label <span class="token operator">=</span> <span class="token keyword">NULL</span><span class="token punctuation">,</span>
        homebutton <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><h4 id="ベースマップの変更"><a href="#ベースマップの変更" aria-hidden="true" class="header-anchor">#</a> ベースマップの変更</h4> <div class="language-r line-numbers-mode"><pre class="language-r"><code><span class="token comment"># これらのタイルがベースマップとして利用可能</span>
mapviewGetOption<span class="token punctuation">(</span><span class="token string">&quot;basemaps&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language- line-numbers-mode"><pre class="language-text"><code>## [1] &quot;CartoDB.Positron&quot;   &quot;CartoDB.DarkMatter&quot; &quot;OpenStreetMap&quot;     
## [4] &quot;Esri.WorldImagery&quot;  &quot;OpenTopoMap&quot;
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><div class="language-r line-numbers-mode"><pre class="language-r"><code><span class="token comment"># ref) https://leaflet-extras.github.io/leaflet-providers/preview/</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><div class="language-r line-numbers-mode"><pre class="language-r"><code>mapview<span class="token punctuation">(</span>sf_pref01<span class="token punctuation">,</span> map.types <span class="token operator">=</span> <span class="token string">&quot;Esri.WorldImagery&quot;</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="保存"><a href="#保存" aria-hidden="true" class="header-anchor">#</a> 保存</h4> <p><code>mapview::mapshot()</code>を使います。これはwebshotパッケージのラッパーとして機能する関数です。</p> <h2 id="deckgl"><a href="#deckgl" aria-hidden="true" class="header-anchor">#</a> deckgl</h2> <p>Uberが開発に携わるオープンソース</p> <p>deck.gl</p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>library<span class="token punctuation">(</span>mapdeck<span class="token punctuation">)</span>

<span class="token comment"># mapdeck::set_token()</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="plotly"><a href="#plotly" aria-hidden="true" class="header-anchor">#</a> plotly</h2> <p>地図タイルを使わない</p> <p>地図以外のグラフが描画できる</p> <p>[WIP]</p> <div class="language-r line-numbers-mode"><pre class="language-r"><code>library<span class="token punctuation">(</span>plotly<span class="token punctuation">)</span>

plot_geo<span class="token punctuation">(</span>sf_pref01<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="アニメーショングラフ"><a href="#アニメーショングラフ" aria-hidden="true" class="header-anchor">#</a> アニメーショングラフ</h2> <ul><li>気象データ</li> <li>人口データ、時系列?</li></ul> <div class="language-r line-numbers-mode"><pre class="language-r"><code>library<span class="token punctuation">(</span>gganimate<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/tsukubar/r-spatial-guide/edit/master/docs/spatial-data-mapping.md" target="_blank" rel="noopener noreferrer">このページを編集する</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="spatial-data-handling.html" class="prev">
          空間処理
        </a></span> <span class="next"><a href="raster.html">
          ラスタデータ
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/assets/js/9.247023c1.js" defer></script><script src="/assets/js/app.add1969c.js" defer></script>
  </body>
</html>
